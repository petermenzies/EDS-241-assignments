---
title: "EDS241: Take Home Final"
author: "Peter Menzies"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: no
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}

# set default chunk options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, message = FALSE, warning = FALSE)


# load packages
librarian::shelf("stargazer", "here", "tidyr", "dplyr","stringr", "janitor", 
           "cowplot", "ggplot2", "tinytex", "datasets", "tibble", "tidyverse", 
            "estimatr", "car", "xtable", "AER")

options(xtable.comment = FALSE)
```

```{r}
#simple function to make formatted table
tablr <- function(obj) {
  
    obj %>%
    tidy() %>% 
    xtable()
}
```

# Reading in data

```{r , include=TRUE}
df <- read_csv(here("data", "KM_EDS241.csv")) %>% 
  clean_names() %>% 
  mutate(nearinc = as.factor(nearinc))
```

# (a) OLS regression of real house values on the indicator for being located near the incinerator in 1981.

```{r}
df_81 <- df %>% 
  filter(year == "1981")
```

```{r}
ols_a <- lm_robust(rprice ~ nearinc, df_81)
```

```{r, include=FALSE, results='hide'}
penalty_a <- ols_a$coefficients["nearinc1"]
ols_a %>% summary()
```

```{r, results='asis'}
tablr(ols_a)
```




\noindent The estimated "penalty" in value for houses near the incinerator based on the previous OLS regression is `r penalty_a`..

\noindent This estimate does *not* correspond to the causal effect of being near the incinerator on housing values. The regression does not include the other observed determinants of housing value included in the dataset (`age`, `rooms`, `area`, `land`---which are in fact significantly correlated with both `rprice` and `nearinc`), nor does it control for unobserved determinants of housing value---thus the estimator is subject to omitted variable bias and we cannot infer causality. 

alternate answer

\noindent This estimate does *not* correspond to the causal effect of being near the incinerator on housing values. The regression does not include house value prior to construction of the incinerator nor the other observed determinants of housing value included in the dataset (`age`, `rooms`, `area`, `land`---which are in fact significantly correlated with both `rprice` and `nearinc`). Additionally, the regression does not control for unobserved determinants of housing value. The estimator is thus subject to omitted variable bias and we cannot infer causality. 


# (b) Provide evidence that the location choice of the incinerator was not “random”, but rather selected on the basis of house values and characteristics.

```{r}
df_78 <- df %>% 
  filter(year == 1978)
```

```{r}
ols_b1 <- lm_robust(rprice ~ nearinc, df_78)
ols_b2 <- lm_robust(land ~ nearinc, df_78)
ols_b3 <- lm_robust(rooms ~ nearinc, df_78)
```

```{r, results='asis'}
# rprice ~ nearinc
tablr(ols_b1)
# age ~ nearinc
tablr(ols_b2)
# rooms ~ nearinc
tablr(ols_b3)
```


\noindent The above regressions show that house value, lot size, and number of rooms all had significant correlations with being near the incinerator prior to its construction, thus it is highly unlikely that the location choice of the incinerator was "random".

# (c) Based on the observed differences in (b), explain why the estimate in (a) is likely to be biased downward


\noindent As shown in (b), prior to the incinerator's existence, houses near the incinerator location-to-be tended to be lower in value and were more likely to possess characteristics that are correlated with lower value than those not near the incinerator location. This means that our initial regression in (a) is likely to be biased downwards because we did not control for the differences in baseline characteristics that were determinants of house value and were correlated with `nearinc` status, and thus the estimated effect of being near the incinerator is attempting to account for some of those differences.


# (d) Use a difference-in-differences (DD) estimator to estimate the causal effect of the incinerator on housing values without controlling for house and lot characteristics

```{r}
df <- df %>% 
  mutate("D" = ifelse(year == 1981 & nearinc == 1, 1, 0) %>%
           as.factor())
```

```{r}
DD1 <- lm_robust(rprice ~ nearinc + as.factor(year) + D, df)
```

```{r, include=FALSE, results='hide'}
DD1 %>% summary()
ci_low_e <- DD1$conf.low["D1"]
ci_high_e <- DD1$conf.high["D1"]
```

```{r}
tablr(DD1)
```



```{r}
# calculating DD manually (to confirm regression coefficient)
df_before <- df %>% 
  filter(year == 1978)

df_after <- df %>% 
  filter(year == 1981)

mean_t_before <- mean(df_before[df_before$nearinc == 1,]$rprice)
mean_t_after <- mean(df_after[df_after$nearinc == 1,]$rprice)
mean_c_before <- mean(df_before[df_before$nearinc == 0,]$rprice)
mean_c_after <- mean(df_after[df_after$nearinc == 0,]$rprice)

(mean_t_after - mean_t_before) - (mean_c_after - mean_c_before)
```



**Interpret the magnitude and sign of the estimated DD coefficient**


# (e) Report the 95% confidence interval for the estimate of the causal effect on the incinerator in (d)

The 95% confidence interval for the estimate of the causal effect of the incinerator in (d) is `r ci_low_e` to `r ci_high_e`.



# (f) How does your answer in (d) change when you control for house and lot characteristics? Test the hypothesis that the coefficients on the house and lot characteristics are all jointly equal to 0.



```{r}
DD2 <- lm_robust(rprice ~ nearinc + as.factor(year) + D + land + area + rooms + age, df)
DD2 %>% summary()
```

```{r}
linearHypothesis(DD2, c("land = 0", "age = 0", "rooms = 0", "area = 0"), white.adjust = "hc2") 
```









