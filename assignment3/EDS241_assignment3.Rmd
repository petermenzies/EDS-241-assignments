---
title: "EDS241: Assignment 3"
author: "Peter Menzies"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: no
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}

# set default chunk options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, message = FALSE, warning = FALSE)


# load packages
librarian::shelf("stargazer", "here", "tidyr", "dplyr","stringr", "janitor", 
           "cowplot", "ggplot2", "tinytex", "datasets", "tibble", "tidyverse", 
            "estimatr", "car", "xtable", "readxl")

options(xtable.comment = FALSE)
# options(scipen=999) # not scientific notation
```

# Reading in data

```{r , include=TRUE}
df <- read_csv(here("data", "SMOKING_EDS241.csv")) %>% 
  clean_names()
```

# (a) Mean difference in birth weight of infants with smoking and nonsmoking mothers

```{r , include=TRUE}
df_wt_diff <- df %>% 
  group_by(tobacco) %>% 
  summarize(mean_wt = mean(birthwgt))

wt_diff <- df_wt_diff$mean_wt[df_wt_diff$tobacco == 0] - df_wt_diff$mean_wt[df_wt_diff$tobacco == 1]
#wt_tob_ttest <- t.test(df$birthwgt[df$tobacco == 0], df$birthwgt[df$tobacco == 1])
```

```{r}
t.test(df$alcohol[df$tobacco == 1], df$alcohol[df$tobacco == 0])
```

\noindent The unadjusted mean difference in birth weight of infants with smoking and nonsmoking mothers is `r wt_diff` grams.

\noindent This would correspond to the average treatment effect of maternal smoking during pregnancy on infant birth weight under the assumption that the treatment (i.e. smoking) is statistically independent of all control variables. 

\noindent The mean difference in alcohol consumption during pregnancy (one of the control variables) of smoking and non-smoking mothers is statistically different from zero (shown above with a t.test), and thus we can't make the previous assumption.


# (b) Multiple linear regression of birth weight on smoking and control variables

```{r}
mdl_b <- lm_robust(birthwgt ~ ., df)

mdl_b %>% 
  starprep() %>% 
  stargazer()
```

```{r, include=FALSE}
mdl_b

coef_b <- mdl_b$coefficients[["tobacco"]]
se_b <- mdl_b$std.error[["tobacco"]]
```



\noindent The estimated coefficient on tobacco in this model is `r coef_b` +/- `r se_b`


# (c) Estimating the effect of maternal smoking on birth weight using exact matching estimator

```{r}
df_c <- df %>% 
  mutate(mage = case_when(mage >= 34 ~ 1,
                          mage < 34 ~ 0)) %>% 
  mutate(meduc = case_when(meduc >= 16 ~ 1,
                           meduc < 16 ~ 0)) %>% 
  mutate(g = as.factor(paste0(mage, meduc, mblack, alcohol)))
```

```{r}
tia <- df_c %>%
  group_by(g, tobacco) %>% 
  summarise(n_obs = n(),
            mean_wt = mean(birthwgt, na.rm = T)) %>%
  gather(variables, values, n_obs:mean_wt) %>% 
  mutate(variables = paste0(variables, "_", tobacco)) %>% 
  pivot_wider(id_cols = g, names_from = variables, values_from = values) %>% 
  ungroup() %>% 
  mutate(wt_diff = mean_wt_1 - mean_wt_0,
         w_ate = (n_obs_0 + n_obs_1) / (sum(n_obs_0) + sum(n_obs_1)),
         w_att = n_obs_1 / sum(n_obs_1)) %>% 
  mutate_if(is.numeric, round, 2)


stargazer(tia, summary = FALSE, digits = 2)


ate = sum((tia$w_ate) * (tia$wt_diff))
ate

att = sum((tia$w_att) * (tia$wt_diff))
att
```

```{r}
lm_c <- lm_robust(birthwgt ~ tobacco + g, df_c)

lm_c %>%
  starprep() %>% 
  stargazer()
```

```{r, include=FALSE}
lm_est_c <- lm_c$coefficients[["tobacco"]] 
```


\noindent The estimated average treatment effect of smoking on birth weight using the exact matching estimator is `r ate` compared with `r lm_est_c` for the analagous linear regression.





# (d) Linear regression of `dnox_masstons` on `nbp`, `D`, and `nbp` x `D`

```{r}
mdl_nbp_D <- lm_robust(dnox_masstons ~ nbp + D + nbp * D, df_D)
```

```{r, results='asis'}
mdl_nbp_D %>% 
  tidy %>% 
  xtable()
```

```{r, echo=FALSE, results='hide'}
mdl_nbp_D %>% summary()
```

```{r, echo=FALSE}
intercept <- mdl_nbp_D$coefficients[['(Intercept)']]
nbp <- mdl_nbp_D$coefficients[['nbp']]
D <- mdl_nbp_D$coefficients[['D']]
nbp_x_D <- mdl_nbp_D$coefficients[['nbp:D']]
```

\noindent The intercept tells us that counties without `nbp` in effect and with a `pct_black` less than or equal to the median saw an estimated decrease of `r abs(intercept)` tons of NOx between 2000 and 2008. 

\noindent The coefficient on `nbp` represents the estimated difference in change in tons of NOx in counties with `nbp` in effect and without `nbp` in effect that both have `pct_black` lower than the median.

\noindent The coefficient on `D` represents the estimated difference in change in tons of NOx in counties with `pct_black` higher than median and `pct_black` lower than median both without `nbp` in effect.

\noindent The coefficient on the interaction between `nbp` and `D` represents the estimated difference in change in tons of NOx associated with implementation of `nbp` in counties with `pct_black` higher than median and counties with `pct_black` lower than median. 



# (e) Predicted `dnox_masstons` in a county without NBP in effect and where `pct_black` is above the sample median

```{r}
x_vals <- tribble(~nbp, ~D,
                    0,   1)

pred_dnox <- predict(mdl_nbp_D,
                     newdata = x_vals,
                     se.fit = TRUE,
                     interval = 'confidence')
```

The predicted `dnox_masstons` in a county without NBP in effect and where `pct_black` is above the sample median is `r pred_dnox$fit[1]` tons of NOx. The 95% confidence interval for this prediction ranges from `r pred_dnox$fit[2]` to `r pred_dnox$fit[3]`.



